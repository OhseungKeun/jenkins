// Jenkins 파이프라인 선언
// "declarative pipeline" 형식을 사용하여 구조적으로 정의
pipeline {
    agent any  // Jenkins 노드(에이전트) 중 아무거나 사용

    environment {
        // Ansible 환경 변수 정의
        // Jenkins가 실행 중인 워크스페이스 내에서 Ansible이 참조할 경로를 지정
    	ANSIBLE_CONFIG = "${WORKSPACE}/centos/ansible.cfg"
    	INVENTORY = "${WORKSPACE}/centos/inventory"
    	PLAYBOOK = "${WORKSPACE}/centos/site.yaml"
    }

    stages {
        // --- 1단계: GitHub 저장소에서 코드 가져오기 ---
        stage('Checkout') {
            steps {
                // Jenkins가 지정된 Git 저장소와 브랜치에서 코드를 clone
                git branch: 'main', url: 'https://github.com/your-org/ansible-deploy.git'
            }
        }

        // --- 2단계: Ansible Syntax Check ---
        stage('Syntax Check') {
            steps {
                // Ansible 플레이북 문법 검사
                // 실제 배포는 하지 않고 YAML 형식, 태스크 구문 오류만 검사
                sh """
                    ansible-playbook -i ${INVENTORY} ${PLAYBOOK} --syntax-check
                """
            }
        }

        // --- 3단계: Ansible Dry Run (Check Mode) ---
        stage('Dry Run') {
            steps {
                // --check 옵션을 사용하여 실제 변경 없이 시뮬레이션 실행
                // 어떤 작업이 수행될지를 미리 확인하는 단계
                sh """
                    ansible-playbook -i ${INVENTORY} ${PLAYBOOK} --check
                """
            }
        }

        // --- 4단계: 실제 배포 ---
        stage('Deploy') {
            steps {
                // Jenkins Credential Store에서 SSH 키를 안전하게 불러와 사용
                // credentialsId: Jenkins에 등록된 SSH 키 ID
                withCredentials([sshUserPrivateKey(credentialsId: 'ansible-key', keyFileVariable: 'SSH_KEY')]) {
                    sh """
                        ansible-playbook -i ${INVENTORY} ${PLAYBOOK} --private-key=$SSH_KEY
                    """
                }
            }
        }
    }

    // --- 파이프라인 실행 결과 후처리 ---
    post {
        success {
            // 모든 stage가 성공하면 Jenkins 콘솔에 성공 메시지 출력
            echo "✅ Ansible 배포 성공!"
        }
        failure {
            // 실패 시 메시지 출력 (이메일/슬랙 알림을 여기에 추가할 수도 있음)
            echo "❌ 배포 실패 — 로그를 확인하세요."
        }
    }
}
